<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hzl.mapper.UserMapper">
    <resultMap id="UsersResultMap" type="com.hzl.entity.UserDto">
        <id property="id" column="id"/>
        <result column="username" property="username" jdbcType="VARCHAR"/>
        <result column="create_time" property="create_time" jdbcType="TIMESTAMP"/>
        <result column="phone" property="phone" jdbcType="VARCHAR"/>
        <result column="enabled" property="enabled" jdbcType="VARCHAR"/>
        <result column="role_name" property="role_name" jdbcType="VARCHAR"/>
    </resultMap>

    <select id="getUserByUserName" resultType="com.hzl.entity.UserDto">
        select * from sys_user where username = #{username}
    </select>

    <select id="findPermissionByUserId" resultType="com.hzl.entity.Permission">
        SELECT * FROM `sys_permission` where id in(select pid from sys_role_permission where rid in(select rid from sys_role_user where uid = #{userId}))
    </select>

    <select id="getUsers" resultMap="UsersResultMap">
        select u.id,u.username,u.create_time,u.phone,u.enabled,r.role_name from sys_user u
        INNER JOIN sys_role_user ru on u.id = ru.uid
        INNER JOIN sys_role r on ru.rid = r.id
        <where>
            <if test="username != null and username!=''">
                trim(replace(u.username,' ','')) LIKE CONCAT('%',trim(replace(#{username},' ','')),'%' )
            </if>
        </where>
        ORDER BY u.create_time LIMIT #{page},#{rows}
    </select>

    <select id="getUsersCount" resultType="int">
        select count(1) from sys_user
        <where>
            <if test="username != null and username!=''">
                trim(replace(u.username,' ','')) LIKE CONCAT('%',trim(replace(#{username},' ','')),'%' )
            </if>
        </where>
    </select>
</mapper>